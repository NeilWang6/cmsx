(function(i,m){var j=i.util.substitute,x=/^(0|86)?1[3458]\d{9}$/,g,r,e,p,t,u,k,h,d,a,s,w,o={aliDomain:"partner.china.alibaba.com",appendTo:"body",token:"",dialog:{center:true,fadeIn:300,fadeOut:300}},q={},f,c,y,l,b,v;g=m.mbauth=function(z){if(typeof z==="string"){switch(z){case"close":g.close();break;case"submit":g.submit();break}}else{q=i.extend(true,{},o,z);l=q.token;i.use("web-valid",function(){g._init()})}};i.extend(m.mbauth,{checkMobileIsBinding:"http://{0}/member/ajax/check_mobile_is_binding.do",sendValidateMobileCode:"http://{0}/member/ajax/Send_Validate_Mobile_Code.do",sendCancelMobileValidateCode:"http://{0}/member/ajax/Send_Cancel_Mobile_Validate_Code.do",mobileValidation:"http://{0}/member/ajax/mobile_validation.do",cancelMobileValidation:"http://{0}/member/ajax/Cancel_Mobile_Validation.do",_init:function(){i.ajax(j(g.checkMobileIsBinding,[q.aliDomain]),{dataType:"jsonp",data:{_csrf_token:l},success:function(z){if(z.success){if(!v){g._render();g._buildEvent();v=true}f=false;g.vAuth.active(true);if(z.data.isBind==="true"){b=true;p.html("更换手机号码前需先完成安全验证！");g.vAuth.active(h,false);h.val(z.data.mobile).hide();a.html(z.data.mobile).show();s.css("visibility","hidden");k.removeClass("send-disabled")}else{b=false;p.html("通过手机验证，可享受手机登录阿里巴巴、手机找回密码等服务");h.show();if(z.data.mobile){h.val(z.data.mobile);k.removeClass("send-disabled")}else{h.val("");k.addClass("send-disabled")}a.hide()}t.show();u.hide();i.use("ui-dialog",function(){var A=q.dialog.open,B=q.dialog.close;q.dialog.open=function(){i("input:visible:eq(0)",t).focus();A&&A()};q.dialog.close=function(){g.vAuth.active(false);B&&B()};r.dialog(q.dialog)})}}})},_render:function(){r=i("<div>",{id:"sys-mbauth",css:{display:"none"}}).html('<div class="wrap">                <div class="title fd-clr"><h3><img alt="阿里巴巴" src="http://img.china.alibaba.com/cms/upload/member/logo2.gif" /></h3><a href="javascript:;" class="close" tabindex="9000"></a></div>                <div class="box">                    <form action="" method="post" onsubmit="FE.sys.mbauth(\'submit\');return false;" hideFocus="true" autocomplete="off">                        <ul class="tab"><li class="current">手机验证<em class="free">new</em></li><li><button type="submit"></button></li></ul>                        <fieldset>                            <div class="message"></div>                            <dl class="mobile"><dt>手机号码：</dt><dd><input type="text" class="text" maxlength="13" style="width: 120px;" valid="{required:true,type:\'fun\',fun:FE.sys.mbauth.vMobile,key:\'mobile\'}" vg="auth" /><span class="mspan"></span><span class="y">&nbsp;</span><a class="send send-disabled" href="javascript:;"><span class="btn-l"><em>发送验证码</em></span><span class="btn-r"></span></a></dd><dd class="tips"><span class="d">请输入13/14/15/18开头的手机号码</span><span class="s"></span><span class="n"></span></dd></dl>                            <dl class="code"><dt>验证码：</dt><dd><input type="text" class="text" maxlength="6" style="width: 120px;" valid="{required:true,min:6,key:\'code\'}" vg="auth" /><span class="y">&nbsp;</span></dd><dd class="tips"><span class="d">请输入您收到的6位验证码</span><span class="n"></span></dd></dl>                            <dl class="clause"><dt></dt><dd><input id="ma-clause" type="checkbox" checked="checked" valid="{required:true,evt:\'click\',key:\'clause\'}" vg="auth" /><label for="ma-clause">我已看过并同意</label><a title="《阿里巴巴手机验证/绑定规则》" href="http://view.1688.com/cms/shichang/bangding/agreement_order.html" target="_blank">《阿里巴巴手机验证/绑定规则》</a></dd><dd class="tips"><span class="n"></span></dd></dl>                            <dl class="action"><dt>&nbsp;</dt><dd><a class="submit" href="javascript:;"><span class="btn-l"><em>确&nbsp;&nbsp;定</em></span><span class="btn-r"></span></a></dd></dl>                        </fieldset>                        <div class="done" style="display: none;">                            <h6><img alt="" src="http://img.china.alibaba.com/images/common/icon_v02/success3.png" />验证成功！</h6>                            <p>本页将在<em>5</em>秒内跳转。</p>                            <p>如果您的浏览器没有自动刷新，<a class="refresh" href="javascript:FE.sys.mbauth(\'close\');" target="_self">请点击这里</a></p>                        </div>                    </form>                </div>            </div>').appendTo(q.appendTo||"body")},_buildEvent:function(){var C=i("dl.action",r),D=i("a.close",r),B=i("input.text",r),A=false;p=i("div.message",r);h=i(B[0]);d=i(B[1]);a=h.next();s=a.next();e=i("form",r);t=i("fieldset",r);u=i("div.done",r);k=i("a.send",t);w=i("a.submit",r);D.click(function(E){E.preventDefault();g("close")});h.bind("keyup blur",function(){if(!f){if(x.test(this.value)&&!k.hasClass("send-cd")){k.removeClass("send-disabled")}else{k.addClass("send-disabled")}}});k.click(function(L){L.preventDefault();var I=i(this);if(I.hasClass("send-disabled")||I.hasClass("send-cd")){return}var K=60,F=i("em:eq(0)",I),J=I.closest("dl"),M=i("input",J),N=i("span.s",J),G=i("span.n",J),H={_csrf_token:l};function E(){c=setInterval(function(){if(K===1){F.html("发送验证码");I.removeClass("send-cd");if(b||g.vAuth.valid(M)){I.removeClass("send-disabled")}clearInterval(c);c=null}else{F.html(--K+"秒后重发")}},1000);F.html("60秒后重发")}I.addClass("send-disabled send-cd");H.mobile=M.val().replace(/^(0|86)/,"");i.ajax(j(b?g.sendCancelMobileValidateCode:g.sendValidateMobileCode,[q.aliDomain]),{dataType:"jsonp",data:H,success:function(P){if(P.success){J.removeClass("err").addClass("ok");N.html("验证码已发送到您的手机，请立即查收");E()}else{var O=g.vAuth.getConfig(M);O.isValid=false;J.removeClass("ok").addClass("err");I.removeClass("send-cd");if(b||g.vAuth.valid(M)){I.removeClass("send-disabled")}switch(P.data.errMsg.toUpperCase()){case"OVERTIME":G.html("您获取验证码过于频繁，请明天再试");I.addClass("send-disabled");f=true;break;case"VALIDATED":G.html("您输入的手机号码已被使用，请更换其他手机号码");break;case"MOBILE_ERR":G.html("请输入正确手机格式");break;default:G.html("网络繁忙，请稍后重试");break}}},error:function(){J.removeClass("ok").addClass("err");I.removeClass("send-cd");if(b||g.vAuth.valid(M)){I.removeClass("send-disabled")}G.html("网络繁忙，请稍后重试")}})});h.keydown(function(E){if(E.keyCode&&E.keyCode==9){E.preventDefault();d.focus()}});d.keydown(function(E){if(E.keyCode&&E.keyCode==9){E.preventDefault();h.focus()}});B.focus(function(){if(i(this).is(":visible")){var E=i(this).closest("dl");if(E.hasClass("err")&&this.value){this.select()}else{E.addClass("focus")}}}).blur(function(){i(this).closest("dl").removeClass("focus")});this.vAuth=new FE.ui.Valid(i("input[vg=auth]"),{onValid:function(F,G){var E=i(this).closest("dl");n=i("span.n",E).html("");if(F==="pass"){E.removeClass("err").addClass("ok")}else{if(F==="default"){E.removeClass("err ok")}else{switch(F){default:break;case"required":if(G.key==="clause"){n.html("需同意《阿里巴巴手机验证/绑定规则》才可验证手机")}else{n.html("此项为必填项")}break;case"fun":G.msg&&n.html(G.msg);break;case"min":n.html("请输入您收到的6位验证码");break;case"rMobile":n.html("手机已被使用，请更换其他手机");break}E.removeClass("ok").addClass("err")}}}});function z(){A=false}w.click(function(F){F.preventDefault();if(g.vAuth.valid()){if(A){return}A=true;var E={mobile:h.val().replace(/^(0|86)/,""),valcode:d.val(),_csrf_token:l};if(!b){E.type="new"}i.ajax(j(b?g.cancelMobileValidation:g.mobileValidation,[q.aliDomain]),{dataType:"jsonp",data:i.paramSpecial(E),error:function(){A=false},success:function(L){if(L.success==true){var K=5;e[0].reset();if(q.onSuccess){q.onSuccess(u,E,L)}t.hide();u.show();if(y){clearInterval(y);y=null}y=setInterval(function(){if(!--K){g("close")}},1000)}else{var H,J;switch(L.data.errMsg.toLocaleUpperCase()){case"CHECKCODE_ERROR":H=d;J="您输入的验证码不正确，请重新输入";break;case"CHECKCODE_EXPIRED":H=d;J="验证码已过期，请重新获取";break;case"MOBILE_HAS_MODIFY":H=h;J="您的手机号码发生了更改，请重新获取验证码";break;default:A=false;return}var G=H.closest("dl"),I=i("span.n",G);I.html(J);G.addClass("err")}A=false}})}})},close:function(){if(y){clearInterval(y);y=null}if(c){clearInterval(c);y=null;i("em:eq(0)",k).html("发送验证码");k.removeClass("send-cd");if(b||g.vAuth.valid(h)){k.removeClass("send-disabled")}}e[0].reset();r.dialog("close")},submit:function(){w.triggerHandler("click")},vMobile:function(C){var A=i(this).closest("dl"),B=i("a.send",A),z=i("span.s",A);if(!/^\d{11}$/.test(this.value.replace(/^(0|86)/,""))){return"请输入11位数字"}if(!x.test(this.value)){return"请输入13/14/15/18开头的手机号码"}z.html("");return true}})})(jQuery,FE.sys);