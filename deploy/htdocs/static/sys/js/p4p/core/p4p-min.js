FD.namespace("FD.sys.p4p");(function(g,b,h){var a=YAHOO.lang,f=YAHOO.util.Dom,e=YAHOO.util.Event,c=YAHOO.util.Get;b.CONSTANTS={P4P_INIT:"p4p init",P4P_LOAD:"p4p load",P4P_ON_SUCCESS:"p4p success!",P4P_ON_FAILURE:"p4p failure!",end:0};b.API_CONFIG={p4p_api:"http://match.p4p.1688.com/b2bad",entrance:"http://page.1688.com/html/p4p/pro.html?tracelog=p4plist",noimg:{x100:"http://img.china.alibaba.com/images/cn/p4p/nopic_100x100.gif",x150:"http://img.china.alibaba.com/images/cn/market/trade/list/070423/nopic150.gif"},end:0};b.API_PARAM_ITEM_MAP={keyword:"",catid:"",cat:"",tag:"",count:0,beginPage:0,fixBeginPage:0,docid:"",info_catid:"",info_subjid:"",needNextGroup:false,pid:"",p4p:"",mt:"",forumid:"",source:"",dcatid:"",prob:"",retailWholesale:"",isUseAlipay:"",mixWholesaleFlag:"",cosite:"",end:0};b.debug=false;b.Utils={debug:function(i){if(a.isBoolean(i)){b.debug=i}},log:function(k,i,j){if(b.debug){if(j){k=j+": "+k}if(window.console!==h&&console.log){console[i&&console[i]?i:"log"](k)}}return this},error:function(i){if(b.debug){throw i}},p4pClick:function(i,j){var k=new Date();if(document.images&&(!arguments[1]||(arguments[1]&&e.isIE))){(new Image()).src=i+"&j=1&time="+k.getTime()}return true},p4pTraceEnquiryClick:function(l){var j="",k=[];if(typeof getCookie=="function"){j=getCookie("__last_loginid__");if(j!=""){k.push("?fromId="+j);k.push("toId="+(l.toId||""));k.push("offerId="+(l.offerId||""));k.push("source="+(l.source||1));k.push("cna="+(getCookie("cna")||""));var i="";if(l.offerId&&l.offerId!=""){i="http://detail.1688.com/buyer/offerdetail/"+l.offerId+".html"}k.push("sourceUrl="+i);if(typeof window.dmtrack!="undefined"){dmtrack.clickstat("http://interface.xp.1688.com/eq/enquiry/traceEnquiry.json",k.join("&"))}else{d=new Date();if(document.images){(new Image()).src="http://interface.xp.1688.com/eq/enquiry/traceEnquiry.json"+k.join("&")+"&time="+d.getTime()}}return true}}},doRed:function(k,i){var i=i.replace(/[,\s\+]+/g,"|");if(i==""){return k}try{return k.replace(new RegExp("("+i+")","ig"),'<span style="color:red;">$1</span>')}catch(j){return k}},doSubstring:function(m,k,l){var i="",l=l||1,j=k-3;if(m.length>k){if(l==1){i=m.substring(0,j)+"..."}else{if(l==4){i=m.substring(0,k)+"..."}else{i=m.substring(0,k)}}}else{i=m}return i},doSubstringAo:function(q,m,o){var k=0,p="",r=/[^\x00-\xff]/g,n="",j=q.replace(r,"**").length;for(var l=0;l<j;l++){n=q.charAt(l).toString();if(n.match(r)!=null){k+=2}else{k++}if(k>m){break}p+=n}if(o&&j>m){p+="..."}return p},doFitlerData:function(k){var i=[];for(var j=0;j<k.length;j++){if(k[j].TITLE&&k[j].TITLE!=""&&k[j].EURL&&k[j].EURL!=""&&k[j].RESOURCEID&&k[j].RESOURCEID!=""){k[j].EURL=k[j].EURL.replace(/"/g,"&quot;");k[j].TITLE=this.doFitlerInvalidCharacter(k[j].TITLE);k[j].DESC=this.doFitlerInvalidCharacter(k[j].DESC);k[j].COMPANY=this.doFitlerInvalidCharacter(k[j].COMPANY);k[j].REDKEY=this.doFitlerInvalidCharacter(k[j].REDKEY);k[j].RESOURCEID=this.doFitlerInvalidCharacter(k[j].RESOURCEID);i[i.length]=k[j]}}return i},doFitlerInvalidCharacter:function(i){i=i||"";return i.replace(/[\u0000-\u0008]|\u000b|\u000c|[\u000e-\u001f]/gi," ")},getPageId:function(){return typeof window.dmtrack_pageid=="undefined"?"":dmtrack_pageid},getTime:function(){return new Date().getTime()},doReplace:function(i){i=i.replace(/<|>/g,"");return i},p4pTagClick:function(l,m,k){var n=this.getTime(),j=l||"",m=m||"",i=this.getPageId()||"",k=k||"";if(document.images){(new Image()).src="http://stat.1688.com/p4ptag.html?offerid="+j+"&pageid="+i+"&keywords="+m+"&pos=3&pid="+k+"&time="+n}},end:0};b.AbstractP4PView=function(j,i,k){this.result=j||{};this.config=i||{};this.oMergedP4PConfig=k||{};this.stat(j)};a.augmentObject(b.AbstractP4PView.prototype,{stat:function(q){var n=this.config.ctrType||1;if(q&&q.length>0){var k=FD.sys.p4p.Utils.getPageId(),j="",m=[];for(var l=0;l<q.length;l++){if(j==""){j=q[l].REDKEY}m.push(q[l].RESOURCEID+",2;")}var p="http://ctr.1688.com/ctr.html?ctr_type="+n+"&page_area=2&page_id="+k+"&category_id=&object_type=offer&object_ids="+m.join("")+"&keyword="+j+"&page_size=&page_no=&refer="+escape(document.location.href);this._post(p)}},_post:function(i){var j=FD.sys.p4p.Utils.getTime();if(document.images){setTimeout(function(){(new Image()).src=i+"&time="+j},10)}}});b.P4PModel=function(j,i,k){if(typeof j!=="object"){return}this.oP4PConfig=j;this.fnFilter=i;this.oMergedP4PConfig=FD.common.applyIf(this.oP4PConfig||{},b.API_PARAM_ITEM_MAP);this.P4PViewClass=k;this.load()};a.augmentObject(b.P4PModel.prototype,{load:function(){var i=this.getLoadURL();var k={onSuccess:this.onSuccess,onFailure:this.onFailure,onTimeout:this.onTimeout,scope:this,charset:"gb2312",timeout:10000,data:{}};b.Utils.log(b.CONSTANTS.P4P_LOAD);var j=YAHOO.util.Get.script(i,k)},getLoadURL:function(){var i=this._getHost()+"?"+this._getQuery();if(a.isFunction(this.fnFilter)){i=this.fnFilter(i)}return i},_getHost:function(){return b.API_CONFIG.p4p_api},_getQuery:function(){var k=[],j=k.push;k.push("keyword="+this.oMergedP4PConfig.keyword);k.push("catid="+this.oMergedP4PConfig.catid);k.push("cat="+this.oMergedP4PConfig.cat);k.push("tag="+this.oMergedP4PConfig.tag);k.push("count="+this.oMergedP4PConfig.count);var i=this.oMergedP4PConfig.needNextGroup,m=this.oMergedP4PConfig.beginPage||1,l=this.oMergedP4PConfig.fixBeginPage;if(i){_offset=parseInt(this.oMergedP4PConfig.count)*(parseInt(m)-1)}else{_offset=parseInt(this.oMergedP4PConfig.count)*(parseInt(m)-1)+l}k.push("offset="+_offset);k.push("pid="+this.oMergedP4PConfig.pid);k.push("p4p="+this.oMergedP4PConfig.p4p);k.push("mt="+this.oMergedP4PConfig.mt);k.push("forumid="+this.oMergedP4PConfig.forumid);k.push("source="+this.oMergedP4PConfig.source);k.push("docid="+this.oMergedP4PConfig.docid);k.push("category="+this.oMergedP4PConfig.info_catid);k.push("subject="+this.oMergedP4PConfig.info_subjid);k.push("dcatid="+this.oMergedP4PConfig.dcatid);k.push("prob="+this.oMergedP4PConfig.prob);k.push("pageid="+FD.sys.p4p.Utils.getPageId());k.push("retailWholesale="+this.oMergedP4PConfig.retailWholesale);k.push("isUseAlipay="+this.oMergedP4PConfig.isUseAlipay);k.push("mixWholesaleFlag="+this.oMergedP4PConfig.mixWholesaleFlag);k.push("cosite="+this.oMergedP4PConfig.cosite);k.push("t="+FD.sys.p4p.Utils.getTime());return k.join("&")},onSuccess:function(){var i=window[this.oMergedP4PConfig.p4p];if(a.isObject(i)&&i.length>0){b.Utils.log(b.CONSTANTS.P4P_ON_SUCCESS);this.toDo("onSuccess",i)}else{this.onFailure()}},onFailure:function(){b.Utils.log(b.CONSTANTS.P4P_ON_FAILURE,"info");this.toDo("onFailure",{})},onTimeout:function(){b.Utils.log(b.CONSTANTS.P4P_ON_FAILURE,"error");this.onFailure()},toDo:function(j,i){new this.P4PViewClass(j,i,this.oP4PConfig,this.oMergedP4PConfig)},end:0});b.Ao=function(j,i){var k=this;if(!(k instanceof arguments.callee)){return new arguments.callee(j,i)}return{use:function(l){b.Utils.log(b.CONSTANTS.P4P_INIT);new b.P4PModel(j,i,l)},end:0}}})(window,FD.sys.p4p);
