(function(a){a.moduleManager.register("spm",function(){var w=true,j=false,i="data-spm",M="data-spm-anchor-id",S="data-spm-protocol",n="data-spm-has-sub",b="::-plain-::",p=this.globals,r=this.config,h=this.tools,Q=window,k=Q.document,J=j,H={},q=j,t="",O="",N=r.spmServer,o=j,c=function(G,C){return G.indexOf(C)>-1},g=function(G,C){return G.indexOf(C)==0},I=function(){return Math.floor(Math.random()*268435456).toString(16)},m=function(X){var C=[],T,G;for(T in X){if(X.hasOwnProperty(T)){G=""+X[T];C.push(g(T,b)?G:(T+"="+encodeURIComponent(G)))}}return C.join("&")},D=function(G){var T=[],Y,X,Z,C=G.length;for(Z=0;Z<C;Z++){Y=G[Z][0];X=G[Z][1];T.push(g(Y,s_plain_obj)?X:(Y+"="+encodeURIComponent(X)))}return T.join("&")},B=function(T,Y){var G=new Image(),aa="_img_"+Math.random(),X=T.indexOf("?")==-1?"?":"&",Z,C=Y?(h.isArray(Y)?D(Y):m(Y)):"";Q[aa]=G;G.onload=G.onerror=function(){Q[aa]=null};G.src=Z=C?(T+X+C):T;G=null;return Z},y=function(){return k.getElementsByTagName("meta")},u=function(){var Y=y(),T,G,X,C;for(T=0,G=Y.length;T<G;T++){X=Y[T];C=h.tryToGetAttribute(X,"name");if(C==i){t=h.tryToGetAttribute(X,S);O=h.tryToGetAttribute(X,"content")}}},x=function(){var T="",G="",C;u();if(Q._SPM_a&&Q._SPM_b){T=Q._SPM_a.replace(/^{(\w+)}$/g,"$1");G=Q._SPM_b.replace(/^{(\w+)}$/g,"$1");if(T!=="{}"&&G!=="{}"){J=w}}if(!T||!G||T==="{}"||G==="{}"){T=O;G=h.tryToGetAttribute(k.body,i)||0}C=T+"."+G;if(!T||!G||!/^[\w\-\*]+\.[\w\-\*]+$/.test(C)){C=0}return C},L=function(G){var C;while((G=G.parentNode)&&G.tagName!="BODY"){C=h.tryToGetAttribute(G,S);if(C){return C}}return""},d=function(C){if(Q.jQuery){jQuery(k).ready(C)}else{if(k.readyState==="complete"){C()}else{h.on(Q,"load",C)}}},R=function(){if(q){return}if(!Q.spmData){if(!o){setTimeout(arguments.callee,100)}return}q=w;var X=Q.spmData["data"],T,C,Y,G;if(!X||!h.isArray(X)){return}for(T=0,C=X.length;T<C;T++){Y=X[T];G=Y.xpath;H[G]={spmc:Y.spmc,spmd:Y.spmd}}},P=function(Y){var aa=k.getElementsByTagName("*"),G,X,T,ab,Z,C;for(G=[];Y&&Y.nodeType==1;Y=Y.parentNode){if(Y.id){C=Y.id;ab=0;for(X=0;X<aa.length;X++){Z=aa[X];if(Z.id&&Z.id==C){ab++;break}}if(ab==1){G.unshift('id("'+C+'")');return G.join("/")}else{G.unshift(Y.tagName.toLowerCase()+'[@id="'+C+'"]')}}else{for(X=1,T=Y.previousSibling;T;T=T.previousSibling){if(T.tagName==Y.tagName){X++}}G.unshift(Y.tagName.toLowerCase()+"["+X+"]")}}return G.length?"/"+G.join("/"):null},e=function(C){var G=H[P(C)];return G?G.spmc:""},V=function(C){return C?(!!C.match(/^[^\?]*\balipay\.(?:com|net)\b/i)):false},F=function(G){var X,C,T;if(J){C=P(G);T=H[C];if(T){X=T.spmd}}else{X=h.tryToGetAttribute(G,i);if(!X||!X.match(/^d\w+$/)){X=""}}return X},f=function(T){var X=k.getElementsByTagName("a"),C=X.length,G;for(G=0;G<C;G++){if(X[G]===T){return G+1}}return 0},W=function(T,ac){if(T&&/&?\bspm=[^&#]*/.test(T)){T=T.replace(/&?\bspm=[^&#]*/g,"").replace(/&{2,}/g,"&").replace(/\?&/,"?").replace(/\?$/,"")}if(!ac){return T}var ad,Z,ab,aa="&",X,G,C,Y;if(T.indexOf("#")!=-1){ab=T.split("#");T=ab.shift();Z=ab.join("#")}X=T.split("?");G=X.length-1;ab=X[0].split("//");ab=ab[ab.length-1].split("/");C=ab.length>1?ab.pop():"";if(G>0){ad=X.pop();T=X.join("?")}if(ad&&G>1&&ad.indexOf("&")==-1&&ad.indexOf("%")!=-1){aa="%26"}T=T+"?spm="+ac+(ad?(aa+ad):"")+(Z?("#"+Z):"");Y=c(C,".")?C.split(".").pop().toLowerCase():"";if(Y){if(({png:1,jpg:1,jpeg:1,gif:1,bmp:1,swf:1}).hasOwnProperty(Y)){return 0}if(!ad&&G<=1){if(!Z&&!({htm:1,html:1,php:1}).hasOwnProperty(Y)){T+="&file="+C}}}return T},E=function(Y,C){var X=Y,T=h.tryToGetHref(X),Z=(h.tryToGetAttribute(X,S)||L(X)||t)=="i",G=N+"?spm=";if(!T||!C){return}if(T.indexOf("#")===0||T.toLowerCase().indexOf("javascript:")===0||V(T)){return}if(Z){G+=C+"&st_page_id="+p.pageId+"&url="+encodeURIComponent(T)+"&cache="+I();B(G)}else{(T=W(T,C))&&s(X,T)}},s=function(Y,T){var X=Y,C,G=X.innerHTML;if(G&&G.indexOf("<")==-1){C=k.createElement("b");C.style.display="none";X.appendChild(C)}X.href=T;if(C){X.removeChild(C)}},K=function(G){var C;return(G&&(C=G.match(/&?\bspm=([^&#]*)/)))?C[1]:""},v=function(X){var T=X,G=F(T)||f(T),C=[x(),0,G].join(".");E(T,C)},A=function(T){var C,G=T.tagName.toLowerCase(),X={};while(T&&G!=="html"&&G!=="body"){if(!J){C=h.tryToGetAttribute(T,i)}else{C=e(T)}if(C){X={spmEl:T,spmId:C};break}if(!(T=T.parentNode)){break}G=T.tagName.toLowerCase()}return X},l=function(Y,ad){var T=Y,ab=ad.spmEl,af=ad.spmId,ae=[x(),af].join(".");if(!ae.match||!ae.match(/^[\w\-\*]+\.[\w\-\*]+\.[\w\-\*]+$/)){return}var ai=h.nodeListToArray(ab.getElementsByTagName("a")),ah=h.nodeListToArray(ab.getElementsByTagName("area")),G=ai.concat(ah),aa,C,ac,X=0;for(var Z=0,ag=G.length;Z<ag;Z++){aa=G[Z];C=h.tryToGetHref(aa);if(!C){continue}X++;if(aa===T){ac=ae+"."+(F(aa)||X);h.tryToSetAttribute(aa,M,ac);break}}},z=function(G){var C=G,T=h.tryToGetAttribute(C,M),X;if(!T){X=A(C.parentNode);if(!X.spmId){v(C);return}l(C,X);T=h.tryToGetAttribute(C,M)}E(C,T)},U=function(){d(function(){o=w;if(!x()){return}R();h.on(k.body,"mousedown",function(T,G){var C;while(G&&(C=G.tagName.toLowerCase())){if(C==="a"||C==="area"){z(G);break}else{if(C==="body"||C==="html"){break}}G=G.parentNode}})})};return{init:U}})}(MAGNETO));
