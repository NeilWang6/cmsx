!(function(){var $Y=YAHOO,$L=$Y.lang,win=window,doc=document,head=doc.getElementsByTagName("head")[0],ie=$Y.env.ua.ie,ie6=(ie===6),DEFAULT_DATA_SOURCE="http://suggest.1688.com/bin/suggest";SUGGEST_ID="suggest-style",SUGGEST_CONTAINER_CLASS="suggest-container",SUGGEST_KEY_CLASS="suggest-key",SUGGEST_RESULT_CLASS="suggest-result",SUGGEST_SELECTED_ITEM_CLASS="selected",SUGGEST_TIPS_CLASS="suggest-tips",SUGGEST_BOTTOM_CLASS="suggest-bottom",SUGGEST_CLOSE_BTN_CLASS="suggest-close-btn",SUGGEST_SHIM_CLASS="suggest-shim",EVENT_BEFORE_DATA_REQUEST="beforeDataRequest",EVENT_ON_DATA_RETURN="onDataReturn",EVENT_BEFORE_SHOW="beforeShow",EVENT_ON_ITEM_SELECT="onItemSelect",defaultConfig={containerClass:"",myParam:"",containerWidth:"auto",resultFormat:"\u7ea6%result%\u6761\u7ed3\u679c",showTis:true,showCloseBtn:false,closeBtnText:"\u5173\u95ed",useShim:ie6,timerDelay:200,autoFocus:false,submitFormOnClickSelect:false,varName:"_suggest_result_",leftOffset:0,topOffset:0,showNum:0,titleLength:0,customClick:null,suggestTracelogShow:"",suggestTracelogSubmit:"",suggestTracelogClick:"",suggestTracelogType:"",suggestTracelogIndex:0};FD.widget.Suggest=function(q,dataSource,config){var that=this;if(!(this instanceof arguments.callee)){return new arguments.callee(q,dataSource,config)}this.textInput=$D.get(q);this.dataSource=dataSource||DEFAULT_DATA_SOURCE;this.returnedData=null;this.config=$L.merge(defaultConfig,config||{});this.container=null;this.query="";this.queryParams="";this._timer=null;this._isRunning=false;this.dataScript=null;this._dataCache={};this._latestScriptTime="";this._scriptDataIsOut=false;this._onKeyboardSelecting=false;this.selectedItem=null;this.suggestTracelogKeyword="";this.suggestTracelogRecommendedword="";this.suggestTracelogCategory="";this._index=-1;this._init();return this};$L.augmentObject(FD.widget.Suggest.prototype,{_init:function(){this._initTextInput();this._initContainer();if(this.config.useShim){this._initShim()}this._initStyle();this.createEvent(EVENT_BEFORE_DATA_REQUEST);this.createEvent(EVENT_ON_DATA_RETURN);this.createEvent(EVENT_BEFORE_SHOW);this.createEvent(EVENT_ON_ITEM_SELECT);this._initResizeEvent()},_initTextInput:function(){var instance=this;this.textInput.setAttribute("autocomplete","off");$E.on(this.textInput,"blur",function(){instance.stop()});$E.on(this.textInput,"focus",function(){instance._setContainerRegion();instance._setShimRegion();var items=instance.container.getElementsByTagName("li");if(items.length==0){return}instance.start()});$E.on(this.textInput,"click",function(e){e=e||win.event;e.cancelBubble=true});if(this.config.autoFocus){this.textInput.focus()}var pressingCount=0;$E.on(this.textInput,"keydown",function(ev){var keyCode=ev.keyCode;switch(keyCode){case 27:instance.hide();instance.textInput.value=instance.query;break;case 13:if(instance._onKeyboardSelecting){if(instance.textInput.value==instance._getSelectedItemKey()){instance.fireEvent(EVENT_ON_ITEM_SELECT,instance.textInput.value)}}instance.textInput.blur();instance.hide();if(instance.config.customClick){instance.config.customClick()}instance._submitForm();return;break;case 40:case 38:if(pressingCount++==0){if(instance._isRunning){instance.stop()}instance._onKeyboardSelecting=true;instance.selectItem(keyCode==40)}else{if(pressingCount==3){pressingCount=0}}break}if(keyCode!=40&&keyCode!=38){if(!instance._isRunning){instance.start()}instance._onKeyboardSelecting=false}});$E.on(this.textInput,"keyup",function(){pressingCount=0;instance.suggestTracelogKeyword=this.value})},_initContainer:function(){var container=doc.createElement("div"),customContainerClass=this.config.containerClass;container.className=SUGGEST_CONTAINER_CLASS;if(customContainerClass){container.className+=" "+customContainerClass}container.style.position="absolute";container.style.visibility="hidden";this.container=container;this._setContainerRegion();this._initContainerEvent();doc.body.insertBefore(container,doc.body.firstChild)},_setContainerRegion:function(){that=this;var r=$D.getRegion(this.textInput);var left=r.left,w=r.right-left-2;w=w>0?w:0;if(ie&&ie<8){left+=2}this.container.style.left=this.config.leftOffset+left+"px";this.container.style.top=this.config.topOffset+r.bottom+"px";if(this.config.containerWidth=="auto"){this.container.style.width=w+"px"}else{this.container.style.width=this.config.containerWidth}},_initContainerEvent:function(){var instance=this;$E.on(this.container,"mousemove",function(ev){var target=$E.getTarget(ev);if(target.nodeName!="LI"){target=$D.getAncestorByTagName(target,"li")}if($D.isAncestor(instance.container,target)){if(target!=instance.selectedItem){instance._removeSelectedItem();instance._setSelectedItem(target);instance._index=parseInt($D.getAttribute(target,"index")-1)}}});var mouseDownItem=null;this.container.onmousedown=function(e){e=e||win.event;mouseDownItem=e.target||e.srcElement;e.cancelBubble=true;instance.textInput.onbeforedeactivate=function(){instance.textInput.onbeforedeactivate=null}};$E.on(this.container,"mouseup",function(ev){if(!instance._isInContainer($E.getXY(ev))){return}var target=$E.getTarget(ev);if(target!=mouseDownItem){return}if(target.className==SUGGEST_CLOSE_BTN_CLASS){instance.hide();return}if(target.nodeName!="LI"){target=$D.getAncestorByTagName(target,"li")}if($D.isAncestor(instance.container,target)){instance._updateInputFromSelectItem(target);instance.fireEvent(EVENT_ON_ITEM_SELECT,instance.textInput.value);instance.textInput.blur();instance.hide();instance._clickSelect();if(instance.config.customClick){instance.config.customClick()}instance._submitForm();return}})},_submitForm:function(){if(this.config.submitFormOnClickSelect){var form=this.textInput.form;if(!form){return}FYG("search_category")&&(FYG("search_category").value=this._getSelectedItemCategoryId());if(doc.createEvent){var evObj=doc.createEvent("MouseEvents");evObj.initEvent("submit",true,false);form.dispatchEvent(evObj)}else{if(doc.createEventObject){form.fireEvent("onsubmit")}}this._suggestClick("submit");form.submit()}},_clickSelect:function(){},_isInContainer:function(p){var r=$D.getRegion(this.container);return p[0]>=r.left&&p[0]<=r.right&&p[1]>=r.top&&p[1]<=r.bottom},_initShim:function(){var iframe=doc.createElement("iframe");iframe.src="about:blank";iframe.className=SUGGEST_SHIM_CLASS;iframe.style.position="absolute";iframe.style.visibility="hidden";iframe.style.border="none";iframe.style.backgroundColor="transparent";$D.setStyle(iframe,"filter","progid:DXImageTransform.Microsoft.Alpha(style=0,opacity=0)");this.container.shim=iframe;this._setShimRegion();doc.body.insertBefore(iframe,doc.body.firstChild)},_setShimRegion:function(){var container=this.container,shim=container.shim;if(shim){shim.style.left=(parseInt(container.style.left)-2)+"px";shim.style.top=container.style.top;shim.style.width=(parseInt(container.style.width)+2)+"px"}},_initStyle:function(){var styleEl=$D.get(SUGGEST_ID);if(styleEl){return}var style=".suggest-container{background-color:white;border:1px solid #ccc;z-index:99999;}.suggest-shim{z-index:99998}.suggest-container li{color:#555;font-size:12px;line-height:21px;height:21px;overflow:hidden;vertical-align:middle}.suggest-container li.selected{background-color:#FFEED7;cursor:default}.suggest-key{float:left;text-align:left;padding-left:5px;color:#333;}.suggest-result{float:right;text-align:right;padding-right:5px;color:#c3c3c3}.suggest-container li.selected span{color:#3C3C3C;cursor:default}.suggest-container li .suggest-key{font-weight:bold;}.suggest-container li span b{font-style:normal;font-weight:normal;}.suggest-tips{margin-bottom:2px;clear:both;padding:3px 5px 5px;background-color:#EDECEC;height:12px;overflow:hidden;font:12px/1 Tahoma;}.suggest-tips em {color:#ff0000;}.suggest-bottom{padding:0px 5px 5px;backgrpund-color:#E5E5E5;height:12px;ovrflow:hidden;}.suggest-bottom a:link,.suggest-bottom a:visited{color:#1C60C2; text-decoration:none;}.suggest-bottom a:hover{color:#ff7300;text-decoration:underline;}.suggest-close-btn{float:right;line-height:14px;}.suggest-container li,.suggest-bottom{overflow:hidden;zoom:1;clear:both}.suggest-container{*margin-left:0px;_margin-left:-2px;_margin-top:-3px}.suggest-category{color:#999;padding-left:10px;text-align:right;}";styleEl=doc.createElement("style");styleEl.id=SUGGEST_ID;styleEl.type="text/css";head.appendChild(styleEl);if(styleEl.styleSheet){styleEl.styleSheet.cssText=style}else{styleEl.appendChild(doc.createTextNode(style))}},_initResizeEvent:function(){var instance=this,resizeTimer;var oldHeight=FYD.getClientHeight(),oldWidth=FYD.getClientWidth();$E.removeListener(win,"resize",winResize);$E.on(win,"resize",winResize);function winResize(){if(resizeTimer){clearTimeout(resizeTimer)}resizeTimer=setTimeout(function(){var newHeight,newWidth;newHeight=FYD.getClientHeight();newWidth=FYD.getClientWidth();if(newHeight==oldHeight&&newWidth==oldWidth){return}instance._setContainerRegion();instance._setShimRegion();oldHeight=newHeight;oldWidth=newWidth},50)}},start:function(){FD.widget.Suggest.focusInstance=this;var instance=this;instance._timer=setTimeout(function(){instance.updateContent();instance._timer=setTimeout(arguments.callee,instance.config.timerDelay)},instance.config.timerDelay);this._isRunning=true},stop:function(){FD.widget.Suggest.focusInstance=null;clearTimeout(this._timer);this._isRunning=false},show:function(){var instance=this,container=this.container,shim=container.shim,n=this.config.showNum,li=FYS("li",container),h=21,ol=FYS("ol",container,true);if(n&&n<li.length){ol.style.height=parseInt(h*n)+"px";ol.style.overflow="auto"}if(this.isVisible()){return}container.style.visibility="";ol.scrollTop=0;this._index=-1;if(shim){if(!shim.style.height){var r=$D.getRegion(container);shim.style.height="210px"}shim.style.visibility=""}$E.on(doc,"click",onClickHandler);function onClickHandler(){instance.hide();$E.removeListener(doc,"click",onClickHandler)}},hide:function(){if(!this.isVisible()){return}var container=this.container,shim=container.shim;if(shim){shim.style.visibility="hidden"}container.style.visibility="hidden"},isVisible:function(){return this.container.style.visibility!="hidden"},updateContent:function(){if(!this._needUpdate()){this._displayContainer();return}this._updateQueryValueFromInput();var q=this.query;this._index=-1;if(!$L.trim(q).length){this._fillContainer("");this.hide();return}if(typeof this._dataCache[q]!="undefined"){this.returnedData="using cache";this._fillContainer(this._dataCache[q]);this._displayContainer();this._suggestClick("show")}else{this.requestData()}},_needUpdate:function(){return this.textInput.value!=this.query},requestData:function(){if(!this.config.myParam||this.config.myParam==""){this.queryParams="type=saleoffer&q="+this.query}else{this.queryParams=this.config.myParam+"&q="+this.query}this.fireEvent(EVENT_BEFORE_DATA_REQUEST,this.query);this.dataScript={};this.dataScript.src=this.dataSource+"?"+this.queryParams;var that=this;$Y.util.Get.script(this.dataScript.src,{onSuccess:that.onSuccess,onFailure:that.onFailure,timeout:5000,scope:that,charset:"GB2312"})},onSuccess:function(o){this.handleResponse(o)},onFailure:function(o){},handleResponse:function(o){try{var content="",list=doc.createElement("ol"),len=0,categoryData="";if(this._scriptDataIsOut){return}this.returnedData=eval(this.config.varName);this.summary=this.returnedData.summary?this.returnedData.summary:"";this.keywords=null;if(this.summary&&this.returnedData.result.length>0){this.keywords=this.returnedData.result[0][0].substr(this.returnedData.result[0][0].indexOf("_")+1,this.summary.length)}categoryData=this.returnedData.category||"";this.returnedData=this.formatData(this.returnedData);this.fireEvent(EVENT_ON_DATA_RETURN,this.returnedData);len=this.returnedData.length;this.suggestTracelogIndex=0;if(categoryData&&categoryData.length>0&&FYG("search_category")){for(var i=0;i<categoryData.length;i++){var cateLi=this.formatCategoryData(categoryData[i]);list.appendChild(cateLi)}}if(len>0){for(var i=0;i<len;++i){var itemData=this.returnedData[i];var li=this.formatItem(itemData.key,itemData.result);li.setAttribute("key",YAHOO.lang.trim(itemData.key2));li.setAttribute("title",YAHOO.lang.trim(itemData.key2));li.setAttribute("index",i+1);list.appendChild(li)}content=list}else{this.hide();this._fillContainer("");return}this._fillContainer(content);if(len>0){this.appendBottom()}if($L.trim(this.container.innerHTML)){this.fireEvent(EVENT_BEFORE_SHOW,this.container)}this._dataCache[this.query]=this.container.innerHTML;this._displayContainer();this._suggestClick("show")}catch(e){this.onFailure(o)}},formatCategoryData:function(_data){var _html="",li=doc.createElement("li");keySpan=null,categorySpan=null,val=this.textInput.value;li.setAttribute("categoryId",_data.id);li.setAttribute("key",_data.query);li.setAttribute("index",1);keySpan=doc.createElement("span");keySpan.className=SUGGEST_KEY_CLASS;_data.query=_data.query.replace(val,"<b>"+val+"</b>");keySpan.innerHTML=_data.query;li.appendChild(keySpan);categorySpan=doc.createElement("span");categorySpan.className="suggest-category";categorySpan.innerHTML="\u5728<strong>"+_data.name+"</strong>\u5206\u7c7b\u4e0b\u641c\u7d22";li.appendChild(categorySpan);return li},formatData:function(data){var arr=[];if(!data){return arr}if($L.isArray(data.result)){data=data.result}var len=data.length;if(!len){return arr}var item;var itemTemp;var title;var tlen=this.config.titleLength,val=this.textInput.value;for(var i=0;i<len;++i){item=data[i];if($L.isArray(item)){itemTemp=item[0].replace("_","");itemTemp=itemTemp.replace("%","");var l=itemTemp.lenB();title=(tlen&&l>tlen)?itemTemp.cut(tlen)+"\u2026":itemTemp;title=title.replace(val,"<b>"+val+"</b>");arr[i]={key:title,result:item[1],key2:itemTemp}}}return arr},formatItem:function(key,result){var li=doc.createElement("li");var keyEl=doc.createElement("span");keyEl.className=SUGGEST_KEY_CLASS;keyEl.innerHTML=key;li.appendChild(keyEl);if(typeof result!="undefined"){var resultText=this.config.resultFormat.replace("%result%",result);if($L.trim(resultText)){var resultEl=doc.createElement("span");resultEl.className=SUGGEST_RESULT_CLASS;resultEl.appendChild(doc.createTextNode(resultText));li.appendChild(resultEl)}}return li},appendTis:function(summary,keywords){if(!summary){return}if(this.config.showTis&&summary.length>=2){var tips=doc.createElement("div");tips.className=SUGGEST_TIPS_CLASS;tips.innerHTML='<p>\u8f93\u5165"</span><em>'+summary+'</em>"\u4e5f\u80fd\u5728\u63d0\u793a\u6846\u627e\u5230"<em>'+keywords+'</em>"</p>';this.container.appendChild(tips)}},appendBottom:function(){var bottom=doc.createElement("div");bottom.className=SUGGEST_BOTTOM_CLASS;if(this.config.showCloseBtn){var closeBtn=doc.createElement("a");closeBtn.href="javascript: void(0)";closeBtn.setAttribute("target","_self");closeBtn.className=SUGGEST_CLOSE_BTN_CLASS;closeBtn.appendChild(doc.createTextNode(this.config.closeBtnText));bottom.appendChild(closeBtn);this.container.appendChild(bottom)}},_fillContainer:function(content){if(content.nodeType==1){this.container.innerHTML="";this.container.appendChild(content)}else{this.container.innerHTML=content}this.selectedItem=null},_displayContainer:function(){if($L.trim(this.container.innerHTML)){this.show()}else{this.hide()}},selectItem:function(down){var items=this.container.getElementsByTagName("li");if(items.length==0){return}if(!this.isVisible()){this.show();return}var newSelectedItem,ol=$$("ol",this.container,true),showNum=this.config.showNum;if(!this.selectedItem){}if(down){this._index+=1;if(this._index>=items.length){if(showNum){ol.scrollTop=0}this._index=0}newSelectedItem=items[this._index];if(showNum&&this._index>showNum-1){ol.scrollTop+=21}}else{this._index-=1;if(this._index<0){this._index=items.length-1;if(showNum&&items.length>showNum){ol.scrollTop=(items.length-showNum)*21}}newSelectedItem=items[this._index];if(showNum&&this._index<(items.length-showNum)){ol.scrollTop-=21}}this._removeSelectedItem();if(newSelectedItem){this._setSelectedItem(newSelectedItem);this._updateInputFromSelectItem(newSelectedItem)}},_removeSelectedItem:function(){$D.removeClass(this.selectedItem,SUGGEST_SELECTED_ITEM_CLASS);this.selectedItem=null},_setSelectedItem:function(item){$D.addClass((item),SUGGEST_SELECTED_ITEM_CLASS);this.selectedItem=(item)},_getSelectedItemKey:function(){if(!this.selectedItem){return""}return this.selectedItem.getAttribute("key")},_getSelectedItemCategoryId:function(){if(!this.selectedItem){return""}return this.selectedItem.getAttribute("categoryId")||""},_updateQueryValueFromInput:function(){this.query=this.textInput.value},_updateInputFromSelectItem:function(target){this.textInput.value=this._getSelectedItemKey(this.selectedItem);this.suggestTracelogIndex=target.getAttribute("index");this.suggestTracelogRecommendedword=this._getSelectedItemKey(this.selectedItem);this.suggestTracelogCategory=this._getSelectedItemCategoryId(this.selectedItem)},aliclick:function(o,param){if(typeof window.dmtrack!="undefined"){dmtrack.clickstat("http://stat.1688.com/search/queryreport.html",param)}else{d=new Date();if(document.images){(new Image()).src="http://stat.1688.com/search/queryreport.html"+param+"&time="+d.getTime()}}return true},exposureClick:function(sectionexp){if(typeof window.dmtrack!="undefined"){dmtrack.clickstat("http://stat.1688.com/sectionexp.html",("?sectionexp="+sectionexp))}else{(new Image).src="http://stat.1688.com/sectionexp.html?sectionexp="+sectionexp+"&time="+(+new Date)}},_suggestClick:function(clickType){var tempTraceLog="?searchtrace=";switch(clickType){case"show":var categoryTracelog="";var categories=$$("li[categoryId]",this.container);for(var i=0;i<categories.length;i++){categoryTracelog+=("_"+categories[i].getAttribute("categoryId"))}return this.exposureClick(this.config.suggestTracelogShow+"_"+encodeURIComponent(this.query)+categoryTracelog);break;case"click":tempTraceLog+=this.config.suggestTracelogType+"_suggest_"+encodeURIComponent(this.suggestTracelogKeyword)+"_"+encodeURIComponent(this.suggestTracelogRecommendedword)+"_"+this.suggestTracelogIndex+(this.suggestTracelogCategory?("_"+this.suggestTracelogCategory):"");break;case"submit":if(this.suggestTracelogIndex>0){this._suggestClick("click")}tempTraceLog+=this.config.suggestTracelogSubmit;break;default:break}this.aliclick(this,tempTraceLog)}});$L.augmentObject(FD.widget.Suggest.prototype,YAHOO.util.EventProvider.prototype)})();
